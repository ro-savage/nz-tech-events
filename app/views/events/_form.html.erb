<%= form_with model: event do |f| %>
  <% if event.errors.any? %>
    <div class="alert alert-error">
      <strong>Please fix the following errors:</strong>
      <ul style="margin: 0.5rem 0 0 1rem;">
        <% event.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <fieldset>
    <legend>Event Details</legend>

    <label for="event_title">
      Title *
      <%= f.text_field :title, required: true, placeholder: "e.g., Auckland JavaScript Meetup" %>
    </label>

    <label for="event_event_type">
      Event Type *
      <%= f.select :event_type, event_type_options, { prompt: "Select type..." }, { required: true } %>
    </label>

    <label for="event_description">
      Description *
      <%= f.text_area :description, required: true, rows: 6, placeholder: "Tell people what this event is about..." %>
    </label>

    <label for="event_short_summary">
      Short Summary <small class="text-muted">(optional, shown on event list)</small>
      <%= f.text_area :short_summary, rows: 2, maxlength: 500, placeholder: "Brief summary for the events list. If blank, the first 500 characters of the description will be used." %>
    </label>
  </fieldset>

  <fieldset>
    <legend>Date & Time</legend>

    <div class="grid">
      <label for="event_start_date">
        Start Date *
        <%= f.date_field :start_date, required: true %>
      </label>

      <label for="event_end_date">
        End Date <small class="text-muted">(multi-day events)</small>
        <%= f.date_field :end_date %>
      </label>
    </div>

    <div class="grid">
      <label for="event_start_time">
        Start Time
        <%= f.time_field :start_time %>
      </label>

      <label for="event_end_time">
        End Time
        <%= f.time_field :end_time %>
      </label>
    </div>
  </fieldset>

  <fieldset>
    <legend>Location(s)</legend>

    <div id="locations-container">
      <%= f.fields_for :event_locations do |loc| %>
        <%= render "event_location_fields", f: loc %>
      <% end %>
    </div>

    <button type="button" id="add-location-btn" class="outline secondary" style="margin-top: var(--pico-spacing);">
      + Add Another Location
    </button>

    <label for="event_address" style="margin-top: var(--pico-spacing);">
      Address / Venue <small class="text-muted">(optional, for primary location)</small>
      <%= f.text_area :address, rows: 2, placeholder: "e.g., GridAKL, 12 Madden Street, Auckland" %>
    </label>
  </fieldset>

  <fieldset>
    <legend>Additional Info</legend>

    <label for="event_cost">
      Cost <small class="text-muted">(leave blank for free events)</small>
      <%= f.text_field :cost, placeholder: "e.g., Free, $20, $50-100, Koha" %>
    </label>

    <label for="event_registration_url">
      Registration Link <small class="text-muted">(optional)</small>
      <%= f.url_field :registration_url, placeholder: "https://..." %>
    </label>
  </fieldset>

  <div class="flex gap-1">
    <button type="submit"><%= event.persisted? ? "Update Event" : "Create Event" %></button>
    <a href="<%= event.persisted? ? event_path(event) : root_path %>" role="button" type="button" class="outline secondary">Cancel</a>
  </div>
<% end %>

<script type="text/javascript">
  (function() {
    const citiesByRegion = <%= cities_json %>;
    const locationsContainer = document.getElementById('locations-container');
    const addBtn = document.getElementById('add-location-btn');
    const startDateInput = document.getElementById('event_start_date');
    const endDateInput = document.getElementById('event_end_date');

    let locationIndex = document.querySelectorAll('.location-row').length;

    // Generate region options HTML
    const regionOptionsHtml = '<option value="">Select region...</option>' +
      <%= region_options.map { |label, value| "<option value=\"#{value}\">#{j(label)}</option>" }.join.to_json.html_safe %>;

    // Template for new location row
    function createLocationRow(index) {
      return `
        <div class="location-row" data-location-index="${index}">
          <div class="grid" style="grid-template-columns: 1fr 1fr auto; align-items: end;">
            <input type="hidden" name="event[event_locations_attributes][${index}][position]" value="${index}">
            <input type="hidden" name="event[event_locations_attributes][${index}][_destroy]" value="false" class="destroy-field">

            <label>
              Region *
              <select name="event[event_locations_attributes][${index}][region]"
                      required class="location-region-select" data-index="${index}">
                ${regionOptionsHtml}
              </select>
            </label>

            <label>
              City
              <select name="event[event_locations_attributes][${index}][city]"
                      class="location-city-select" data-index="${index}">
                <option value="">Select city...</option>
              </select>
            </label>

            <button type="button" class="remove-location-btn outline secondary"
                    data-index="${index}"
                    style="margin-bottom: 0; padding: 0.5rem 0.75rem;">
              &times;
            </button>
          </div>
        </div>
      `;
    }

    // Add location button handler
    if (addBtn) {
      addBtn.onclick = function() {
        const html = createLocationRow(locationIndex);
        locationsContainer.insertAdjacentHTML('beforeend', html);
        locationIndex++;
        attachLocationHandlers();
      };
    }

    // Update city dropdown when region changes
    function updateCityDropdown(regionSelect) {
      const index = regionSelect.dataset.index;
      const citySelect = document.querySelector(`.location-city-select[data-index="${index}"]`);
      const region = regionSelect.value;
      const cities = citiesByRegion[region] || [];

      citySelect.innerHTML = '<option value="">Select city...</option>';
      cities.forEach(function(city) {
        const option = document.createElement('option');
        option.value = city;
        option.textContent = city;
        citySelect.appendChild(option);
      });
    }

    // Remove location handler
    function removeLocation(btn) {
      const index = btn.dataset.index;
      const row = document.querySelector(`.location-row[data-location-index="${index}"]`);

      // If row has an ID field (existing record), mark for destruction instead of removing
      const idField = row.querySelector('input[name*="[id]"]');
      if (idField) {
        row.querySelector('.destroy-field').value = 'true';
        row.style.display = 'none';
      } else {
        row.remove();
      }
    }

    // Attach handlers to all location selects and remove buttons
    function attachLocationHandlers() {
      document.querySelectorAll('.location-region-select').forEach(function(select) {
        select.onchange = function() { updateCityDropdown(this); };
      });

      document.querySelectorAll('.remove-location-btn').forEach(function(btn) {
        btn.onclick = function() { removeLocation(this); };
      });
    }

    attachLocationHandlers();

    // Start date -> End date auto-sync
    if (startDateInput && endDateInput) {
      let previousStartDate = startDateInput.value;

      startDateInput.onchange = function() {
        if (!endDateInput.value || endDateInput.value === previousStartDate) {
          endDateInput.value = this.value;
        }
        previousStartDate = this.value;
      };
    }
  })();
</script>
