<script type="text/javascript">
  (function() {
    if (!window.filterConfig) return;

    const citiesByRegion = window.filterConfig.citiesByRegion;
    const STORAGE_KEY = window.filterConfig.storageKey;
    const initialRegion = window.filterConfig.initialRegion;
    const initialCity = window.filterConfig.initialCity;

    const regionSelect = document.getElementById('filter-region');
    const citySelect = document.getElementById('filter-city');
    const eventTypeSelect = document.getElementById('filter-event-type');
    const monthSelect = document.getElementById('filter-month');
    const clearLink = document.getElementById('filter-clear');
    const noResultsMessage = document.getElementById('no-results-message');
    const eventCards = document.querySelectorAll('.event-card');
    const eventsList = document.querySelector('.events-list');

    if (!regionSelect || !citySelect) return;

    // Convert city name to URL slug (lowercase, underscores)
    function cityToSlug(city) {
      return city.toLowerCase().replace(/\s+/g, '_');
    }

    // Convert URL slug back to city name by finding match in cities list
    function slugToCity(slug, region) {
      if (!slug || !region) return '';
      const cities = citiesByRegion[region] || [];
      return cities.find(city => cityToSlug(city) === slug) || '';
    }

    // Load filters - URL params take priority, then localStorage
    function loadFilters() {
      // URL params have priority (for shareable links)
      if (initialRegion) {
        // Convert city slug back to proper city name
        const city = slugToCity(initialCity, initialRegion);
        return { region: initialRegion, city: city };
      }
      // Fall back to localStorage
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          return JSON.parse(saved);
        }
      } catch (e) {}
      return { region: '', city: '' };
    }

    // Save filters to localStorage
    function saveFilters() {
      const filters = {
        region: regionSelect.value,
        city: citySelect.value
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(filters));
    }

    // Update URL without page reload
    function updateUrl() {
      const region = regionSelect.value;
      const city = citySelect.value;

      let path = '/';
      if (region) {
        path = '/' + region;
        if (city) {
          path += '/' + cityToSlug(city);
        }
      }

      // Only update if path changed
      if (window.location.pathname !== path) {
        history.pushState({ region: region, city: city }, '', path);
      }
    }

    // Update city dropdown based on selected region
    function updateCityOptions(selectedCity) {
      const region = regionSelect.value;
      const cities = citiesByRegion[region] || [];

      citySelect.innerHTML = '<option value="">All Cities</option>';
      cities.forEach(function(city) {
        const option = document.createElement('option');
        option.value = city;
        option.textContent = city;
        if (city === selectedCity) {
          option.selected = true;
        }
        citySelect.appendChild(option);
      });
    }

    // Apply filters to show/hide event cards
    function applyFilters(updateBrowserUrl = true) {
      const region = regionSelect.value;
      const city = citySelect.value;
      const eventType = eventTypeSelect ? eventTypeSelect.value : '';
      const month = monthSelect ? monthSelect.value : '';

      let visibleCount = 0;

      eventCards.forEach(function(card) {
        // Multi-location: data-regions and data-cities are comma-separated
        const cardRegions = (card.dataset.regions || '').split(',').filter(Boolean);
        const cardCities = (card.dataset.cities || '').split(',').filter(Boolean);
        const cardEventType = card.dataset.eventType;
        const cardMonth = card.dataset.month;

        // Match if filter region is in card's regions array
        const matchesRegion = !region || cardRegions.includes(region);
        // Match if filter city is in card's cities array
        const matchesCity = !city || cardCities.includes(city);
        const matchesEventType = !eventType || cardEventType === eventType;
        const matchesMonth = !month || cardMonth === month;

        if (matchesRegion && matchesCity && matchesEventType && matchesMonth) {
          card.style.display = '';
          visibleCount++;
        } else {
          card.style.display = 'none';
        }
      });

      // Show/hide no results message
      if (eventCards.length > 0) {
        if (visibleCount === 0) {
          noResultsMessage.style.display = '';
          if (eventsList) eventsList.style.display = 'none';
        } else {
          noResultsMessage.style.display = 'none';
          if (eventsList) eventsList.style.display = '';
        }
      }

      // Show/hide clear link (event type and month not included - they don't persist)
      if (region || city || eventType || month) {
        clearLink.style.display = '';
      } else {
        clearLink.style.display = 'none';
      }

      saveFilters();
      if (updateBrowserUrl) {
        updateUrl();
      }
    }

    // Clear all filters
    window.clearFilters = function() {
      regionSelect.value = '';
      citySelect.value = '';
      if (eventTypeSelect) eventTypeSelect.value = '';
      if (monthSelect) monthSelect.value = '';
      updateCityOptions('');
      applyFilters();
    };

    // Event listeners
    regionSelect.onchange = function() {
      updateCityOptions('');
      applyFilters();
    };

    citySelect.onchange = function() {
      applyFilters();
    };

    if (eventTypeSelect) {
      eventTypeSelect.onchange = function() {
        applyFilters(false); // Don't update URL for event type
      };
    }

    if (monthSelect) {
      monthSelect.onchange = function() {
        applyFilters(false); // Don't update URL for month
      };
    }

    clearLink.onclick = function(e) {
      e.preventDefault();
      clearFilters();
    };

    // Handle browser back/forward buttons
    window.onpopstate = function(event) {
      if (event.state) {
        regionSelect.value = event.state.region || '';
        if (eventTypeSelect) eventTypeSelect.value = ''; // Reset event type (not in URL)
        if (monthSelect) monthSelect.value = ''; // Reset month (not in URL)
        updateCityOptions(event.state.city || '');
        applyFilters(false); // Don't update URL again
      } else {
        // Returned to initial state (no filters)
        regionSelect.value = '';
        if (eventTypeSelect) eventTypeSelect.value = '';
        if (monthSelect) monthSelect.value = '';
        updateCityOptions('');
        applyFilters(false);
      }
    };

    // Initialize on page load
    const saved = loadFilters();
    regionSelect.value = saved.region;
    updateCityOptions(saved.city);
    applyFilters(false); // Don't update URL on initial load (already correct)
  })();
</script>
